name: Deploy Gateway Service

on:
  push:
    branches: [ "main" ]
    paths:
      - 'apps/gateway/**' # åªæœ‰å‰ç«¯ä»£ç å˜åŠ¨æ—¶æ‰è§¦å‘
      - '!apps/gateway/values.yaml'    # 2. æ’é™¤ values.yaml
      - '!apps/gateway/Chart.yaml'     # 3. æ’é™¤ Chart.yamlï¼Œæ”¹ç‰ˆæœ¬å·ä¹Ÿä¸éœ€è¦é‡æ‰“é•œåƒ
      - '.github/workflows/deploy-gateway.yml'
    # ã€æ–°å¢ã€‘æ·»åŠ è¿™ä¸€è¡Œï¼Œå¼€å¯æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  workflow_dispatch:

# èµ‹äºˆ CI è„šæœ¬ä¿®æ”¹ä»“åº“ä»£ç çš„æƒé™
permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–ä»£ç 
      - uses: actions/checkout@v3

      # 2. è®¾ç½® JDK ç¯å¢ƒ
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. Maven ç¼–è¯‘æ‰“åŒ… (åªæ„å»ºå‰ç«¯æ¨¡å—)
      - name: Build with Maven
        run: mvn clean package -pl apps/gateway -am -DskipTests

          # ğŸ”¥ã€æ–°å¢æ­¥éª¤ 1ã€‘è®¾ç½® QEMU (ç”¨äºæ¨¡æ‹Ÿ ARM64 ç¯å¢ƒ)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

          # ğŸ”¥ã€æ–°å¢æ­¥éª¤ 2ã€‘è®¾ç½® Docker Buildx (æ”¯æŒå¤šæ¶æ„æ„å»º)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. ç™»å½• Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      # Tag ä½¿ç”¨ github.sha (Commit Hash) çš„å‰7ä½ï¼Œä½œä¸ºå”¯ä¸€ç‰ˆæœ¬å·
      - name: Build and Push Docker Image
        id: docker_build
        uses: docker/build-push-action@v4
        with:
          context: ./apps/gateway
          file: ./apps/gateway/Dockerfile
          push: true
          # ğŸ”¥ã€æ–°å¢å‚æ•°ã€‘å…³é”®ï¼åŒæ—¶æ„å»º AMD64 å’Œ ARM64 ä¸¤ä¸ªç‰ˆæœ¬
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/k8s-gateway:${{ github.sha }}
            ${{ secrets.DOCKER_USERNAME }}/k8s-gateway:latest

      - name: Update Helm Values
        run: |
          # ã€ä¿®å¤ 1ã€‘å®‰è£… yq éœ€è¦ sudo æƒé™
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          
          # è®¾å®šæ–°çš„ Tag
          NEW_TAG=${{ github.sha }}
          
          # è¯·ç¡®ä¿ä½ çš„ apps/gateway ç›®å½•ä¸‹ç¡®å®æœ‰ values.yaml è¿™ä¸ªæ–‡ä»¶ï¼
          TARGET_FILE="apps/gateway/values.yaml"
          
          echo "Updating $TARGET_FILE with tag $NEW_TAG..."
          
          # ä¿®æ”¹æ–‡ä»¶
          yq -i ".image.tag = \"$NEW_TAG\"" $TARGET_FILE
          
          # é…ç½® Git å¹¶æäº¤
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # åªæœ‰æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶æ‰æäº¤
          if [ -n "$(git status --porcelain)" ]; then
            git add $TARGET_FILE
            git commit -m "chore(ci): update gateway image tag to $NEW_TAG [skip ci]"
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit"
          fi
