name: Deploy marketing-activity Service # <--- 1. ä¿®æ”¹åå­—

on:
  push:
    branches: [ "main" ]
    paths:
      - 'apps/marketing-activity/**'              # 1. ç›‘å¬åŽç«¯ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
      - '!apps/marketing-activity/values.yaml'    # 2. æŽ’é™¤ values.yaml
      - '!apps/marketing-activity/Chart.yaml'     # 3. æŽ’é™¤ Chart.yamlï¼Œæ”¹ç‰ˆæœ¬å·ä¹Ÿä¸éœ€è¦é‡æ‰“é•œåƒ
      - 'deploy-marketing-activity.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3. ä¿®æ”¹ Maven æž„å»ºå‘½ä»¤ï¼ŒæŒ‡å‘åŽç«¯æ¨¡å—
      - name: Build with Maven
        # -pl æŒ‡å®šæ¨¡å—ï¼Œ-am è¿žå¸¦æž„å»ºä¾èµ–
        run: mvn clean package -pl apps/marketing-activity -am -DskipTests

      # ðŸ”¥ã€æ–°å¢žæ­¥éª¤ 1ã€‘è®¾ç½® QEMU (ç”¨äºŽæ¨¡æ‹Ÿ ARM64 çŽ¯å¢ƒ)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

        # ðŸ”¥ã€æ–°å¢žæ­¥éª¤ 2ã€‘è®¾ç½® Docker Buildx (æ”¯æŒå¤šæž¶æž„æž„å»º)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. ä¿®æ”¹ Docker é•œåƒåå’Œä¸Šä¸‹æ–‡
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./apps/marketing-activity # <--- ä¸Šä¸‹æ–‡æ”¹æˆåŽç«¯ç›®å½•
          file: ./apps/marketing-activity/Dockerfile # <--- Dockerfile è·¯å¾„
          push: true
          # ðŸ”¥ã€æ–°å¢žå‚æ•°ã€‘å…³é”®ï¼åŒæ—¶æž„å»º AMD64 å’Œ ARM64 ä¸¤ä¸ªç‰ˆæœ¬
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/k8s-marketing-activity:${{ github.sha }} 
            ${{ secrets.DOCKER_USERNAME }}/k8s-marketing-activity:latest

      - name: Update Helm Values
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq
          
          NEW_TAG=${{ github.sha }}
          
          # 5. ä¿®æ”¹ç›®æ ‡ Values æ–‡ä»¶è·¯å¾„
          TARGET_FILE="apps/marketing-activity/values.yaml" 
          
          echo "Updating $TARGET_FILE with tag $NEW_TAG..."
          
          # è¿™ä¸€æ­¥ä¼šè‡ªåŠ¨æŠŠæ–°é•œåƒ tag å†™è¿› git
          yq -i ".image.tag = \"$NEW_TAG\"" $TARGET_FILE
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add $TARGET_FILE
            git commit -m "chore(ci): update marketing-activity image tag to $NEW_TAG [skip ci]"
          
            git pull --rebase origin main
            git push
          else
            echo "No changes to commit"
          fi