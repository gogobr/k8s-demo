server:
  port: 8080

spring:
  application:
    name: k8s-gateway
  cloud:
    nacos:
      discovery:
        # ğŸ”¥ ä¿®æ”¹ç‚¹ï¼šä¼˜å…ˆè¯»å–ç¯å¢ƒå˜é‡ NACOS_SERVER_ADDRï¼Œè¯»ä¸åˆ°æ‰ç”¨åé¢çš„é»˜è®¤å€¼
        server-addr: ${NACOS_SERVER_ADDR:nacos.middleware.svc.cluster.local:8848}
      config:
        # å¦‚æœä½ ä¹Ÿç”¨ Nacos åšé…ç½®ä¸­å¿ƒï¼Œè¿™é‡Œä¹Ÿè¦æ”¹
        server-addr: ${NACOS_SERVER_ADDR:nacos.middleware.svc.cluster.local:8848}
        file-extension: yaml
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: backend-route
          uri: lb://k8s-backend
          predicates:
            - Path=/api/**
          filters:
            - StripPrefix=1
            - AddRequestHeader=X-Gateway-From, k8s-gateway
            # ğŸ”¥ğŸ”¥ğŸ”¥ã€é‡ç‚¹ã€‘é™æµè¿‡æ»¤å™¨ä»£ç åœ¨è¿™é‡Œ ğŸ‘‡
            - name: RequestRateLimiter
              args:
                # å¼•ç”¨åˆšæ‰å†™çš„ Bean (ipKeyResolver)
                key-resolver: "#{@ipKeyResolver}"
                # ä»¤ç‰Œæ¡¶æ¯ç§’å¡«å……é€Ÿç‡ (å…è®¸çš„ QPS = 1) -> æ¯ç§’åªè®¸ 1 ä¸ªè¯·æ±‚
                redis-rate-limiter.replenishRate: 1
                # ä»¤ç‰Œæ¡¶å®¹é‡ (å…è®¸çš„çªå‘æµé‡ = 2) -> å“ªæ€•ç©ºé—²å¾ˆä¹…ï¼Œæœ€å¤šä¹Ÿåªèƒ½æ”’ 2 ä¸ªä»¤ç‰Œ
                redis-rate-limiter.burstCapacity: 2
                # æ¯ä¸ªè¯·æ±‚æ¶ˆè€—å¤šå°‘ä¸ªä»¤ç‰Œ
                redis-rate-limiter.requestedTokens: 1

management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
  metrics:
    tags:
      application: ${spring.application.name}